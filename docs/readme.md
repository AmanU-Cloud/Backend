Техническое задание (ТЗ)

⸻

1. Цель проекта

Разработать высокопроизводительный сервис для асинхронной обработки PDF-файлов с возможностью:
	1.	Приема файлов от клиента и присвоения каждой операции уникального идентификатора.
	2.	Асинхронной обработки файлов на сервере.
	3.	Получения статуса обработки и результата по ID операции.
	4.	Обеспечения идемпотентности запросов с уникальными ключами.
	5.	Ограничения нагрузки (rate-limiting) и числа одновременно загружаемых файлов.
	6.	Временного хранения информации об операциях без использования базы данных.

⸻

2. Функциональные требования

2.1. Загрузка PDF-файлов

Метод: POST /upload
Описание: Клиент загружает один или несколько PDF-файлов на сервер для обработки.

Заголовки:
	•	X-Operation-Key (string, обязательный) — уникальный ключ идемпотентности.

Параметры формы:
	•	files — массив PDF-файлов (максимум 20 файлов за один запрос).

Ответ:
	•	HTTP 200 OK

{
  "ids": ["uuid1", "uuid2", "..."]
}

	•	HTTP 400 Bad Request — ошибка запроса (отсутствие ключа, превышение лимита файлов, некорректный файл).
	•	HTTP 409 Conflict — операция с таким ключом идемпотентности уже существует.

Поведение:
	1.	Проверка ключа идемпотентности. Если ключ уже использовался — возвращается 409 Conflict.
	2.	Файлы сохраняются на сервере в уникальных именах, связанных с UUID операции.
	3.	Каждой операции присваивается статус NEW и сохраняется в мемкэше.
	4.	Операции помещаются в канал обработки.
	5.	Асинхронная обработка изменяет статус операции:
	•	PROGRESS — обработка в процессе
	•	DONE — обработка завершена успешно
	•	ERROR — произошла ошибка при обработке

⸻

2.2. Получение статуса и результата операции

Метод: GET /get
Параметры:
	•	id (query, string, обязательный) — идентификатор операции.

Заголовки:
	•	Accept (optional):
	•	application/json — возвращает информацию о статусе и результат в JSON.
	•	application/pdf — возвращает PDF-файл, если статус DONE.

Ответ:
	•	HTTP 200 OK
	•	JSON (если Accept: application/json или файл еще не готов):

{
  "id": "uuid",
  "status": "NEW|PROGRESS|DONE|ERROR",
  "error": "Описание ошибки, если есть"
}

	•	PDF (если Accept: application/pdf и статус DONE)
	•	HTTP 404 Not Found — операция с указанным ID не найдена.

Поведение:
	•	Клиент опрашивает сервер каждые 5 секунд.
	•	Если статус DONE, сервер возвращает результат в формате, указанном в заголовке Accept.
	•	Если статус ERROR, возвращается описание ошибки.

⸻

2.3. Идемпотентность
	•	Каждое обращение с POST /upload должно содержать уникальный X-Operation-Key.
	•	Один ключ привязан к конкретному набору файлов и пользователю.
	•	Повторная отправка запроса с тем же ключом не создает новых операций и возвращает 409 Conflict.

⸻

2.4. Ограничения
	1.	Максимум 20 файлов за один запрос.
	2.	Rate limiter: не более одного запроса на 30 секунд на пользователя/ключ.
	3.	Мемкэш хранит операции временно (например, 1 час), по истечении времени данные удаляются.

⸻

2.5. Асинхронность
	•	Все операции обрабатываются асинхронно через канал и горутины.
	•	Статус операции изменяется по мере обработки: NEW → PROGRESS → DONE/ERROR.
	•	Клиент получает идентификатор операции сразу после загрузки и опрашивает сервер для получения результата.

⸻

3. Нефункциональные требования
	1.	Язык реализации: Go (1.23+).
	2.	Сервис не использует базу данных, все данные хранятся в оперативной памяти (мемкэш).
	3.	Обработка файлов должна быть потоковой, с ограничением максимального количества одновременно обрабатываемых файлов.
	4.	Логирование всех операций и ошибок.
	5.	Минимальная зависимость от сторонних библиотек (кроме стандартной библиотеки Go и необходимых для мемкэша, обработки PDF и Swagger).

⸻

4. Swagger / OpenAPI 3.0

openapi: 3.0.0
info:
  title: PDF Processing Service
  version: 1.0.0
  description: Асинхронный сервис обработки PDF с идемпотентностью

paths:
  /upload:
    post:
      summary: Загрузка PDF-файлов
      description: Загружает PDF-файлы для обработки и возвращает ID операций
      parameters:
        - in: header
          name: X-Operation-Key
          schema:
            type: string
          required: true
          description: Ключ идемпотентности
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                files:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        '200':
          description: Возвращает ID операций
          content:
            application/json:
              schema:
                type: object
                properties:
                  ids:
                    type: array
                    items:
                      type: string
        '400':
          description: Ошибка запроса (отсутствие ключа, превышение лимита файлов)
        '409':
          description: Ключ идемпотентности уже использовался

  /status:
    get:
      summary: Получение статуса и результата
      parameters:
        - in: query
          name: id
          required: true
          schema:
            type: string
          description: ID операции
      responses:
        '200':
          description: Статус операции и результат (JSON или PDF)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  status:
                    type: string
                    enum: [NEW, PROGRESS, DONE, ERROR]
                  error:
                    type: string
                    nullable: true
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          description: Операция не найдена


⸻

5. Архитектурные решения
	1.	Асинхронная обработка: через канал и горутины.
	2.	Мемкэш: хранение операций в памяти с возможностью удаления по TTL.
	3.	Идемпотентность: проверка по X-Operation-Key.
	4.	Rate limiting: на уровне HTTP-хэндлера (1 запрос на 30 секунд на ключ).
	5.	Безопасность: операции доступны только пользователю с правильным ключом.
